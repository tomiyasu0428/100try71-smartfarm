**AI農場管理 要件定義 3**

**1\. システム概要**

* **システム名:** (仮) SmartFarm Agent  
* **目的:**  
  * 大規模農場や農業チーム向けに、地図インターフェースやチャットベースで営農データ（圃場・資材・作業スケジュールなど）にアクセス・更新できるアプリケーションを提供する。  
  * OpenAI Agents SDK を使った AI エージェントとの対話を通じて、作業予定の管理や作業記録の自動化、問い合わせ応答を可能にする。  
  * スマートフォンから利用することを主目的としつつ、初期導入や詳細設定、地図操作時には PC (Web ブラウザ) からも利用可能。  
* **利用技術:**  
  * **フロントエンド:** TypeScript \+ React / Next.js (SPA あるいは SSR/SSG で構成), **Google Maps Platform (Maps JavaScript API, Drawing Library, Geometry Library 等)**  
  * **サーバサイド:** FastAPI (Python) によるバックエンド API  
  * **AI エージェント:** OpenAI Agents SDK (MCP) による AI エージェント構築  
  * **データベース:** Supabase (PostgreSQL ベース \+ 認証機能)  
  * **インフラ:** AWS/GCP/Azure 等のクラウド (Docker / Kubernetes も検討)  
  * **認証/認可:** Supabase の認証機能を活用 (JWT 準拠)

**2\. 利用想定ユーザーとユースケース**

* **2.1 利用ユーザー想定**

  1. **大規模農家/農業法人:** 作業員やパートスタッフを複数抱え、圃場や作業計画をリアルタイムで共有管理したい。スマホをメインに利用。高齢スタッフもいるため音声入力やシンプルな UI が求められる。地図での圃場管理も活用。  
  2. **農業チーム (集落営農など):** 複数世帯・複数農家が共同で大きな作付けを行うケース。チームメンバー間の作業分担や進捗状況を随時共有したい。  
  3. **JA 営農指導員やコンサルタント (将来的想定):** 生産者に AI を活用した情報提供を行う際、指導員やコンサルタント側も管理者権限でデータを参照し、アドバイスを簡易化したい。  
* **2.2 主なユースケース**

| ユースケース名 | 概要 |
| ----- | ----- |
| UC-1: チャットでの情報問い合わせ | ユーザーが AI エージェントに自然言語で「○○圃場の作業予定は？」「今年の収穫量は？」などを問い合わせると、Supabase から取得した結果を返す。 |
| UC-2: チャットでの作業予定の登録・更新 | 「来週の月曜に圃場 A で耕うん作業を入れて」「田中さんにトラクターの運転を頼んで」とチャットするだけで予定が追加・変更される。 |
| UC-3: チャットでの作業実績/資材使用記録 | 「今日の除草作業を記録」「資材 X を 10 袋使用」とチャットで報告すると、自動的に Supabase に記録し、必要な帳票が更新される。 |
| UC-4: 音声入力への対応 | スマホの音声入力を使い、作業しながら手ぶらでチャット指示や問い合わせを行える。 |
| UC-5: データ可視化/レポート生成 | 「先週の作業時間のグラフを見せて」「今月の作業内容をまとめたレポートを出して」と依頼すると、OpenAI Agents が可視化やドキュメントを生成する。 |
| UC-6: リマインダー/通知 | 「明日は雨なので防除作業を前倒ししては？」「残り資材が少ないので早めに発注を」など、AI からプッシュ通知が届く。 |
| **UC-7: 地図上での圃場登録・編集** | **ユーザーは、UI 上の Google Map で圃場の区画をポリゴン描画し、名称などの情報を入力して圃場データを登録・編集する。描画された領域から面積は自動計算される。** |
| **UC-8: 地図からの圃場選択・情報表示** | **ユーザーが地図上に表示された圃場ポリゴンをクリックすると、その圃場の詳細情報（名称、面積、作付中の作物など）が表示され、編集画面へ遷移できる。** |
| **UC-9: 地図による圃場検索** | **登録済みの圃場を地図上で視覚的に確認し、場所から圃場を探すことができる。** |

Google スプレッドシートにエクスポート

**3\. 機能要件**

* **3.1 コア機能**

  1. **圃場・作物マスタ管理機能**  
     * **圃場情報の管理:**  
       1. 圃場に関する情報（名称、面積、所在地（座標・ポリゴンデータ）、現在作付中の作物種類、土壌タイプ、メモなど）を登録・更新・参照できる。  
       2. **面積:** 地図上で描画されたポリゴンから、連携する面積算出ロジックまたは Google Maps Geometry Library を用いて自動計算された値（単位: 平方メートルまたはヘクタール）を格納する。ユーザーによる手動入力は原則不要とする。  
       3. **所在地（座標・ポリゴンデータ）:** 圃場の区画を Google Map 上で正確に管理するため、標準的な **GeoJSON 形式のポリゴン (Polygon) またはマルチポリゴン (MultiPolygon)** の座標配列データを格納する。  
     * **作物マスタの管理:**  
       1. 作付け品目（例: トマト、キャベツ）やその品種、標準的な栽培日数、生育ステージなどの作物マスタ情報を管理する。  
     * **地図連携インターフェース:**  
       1. **地図表示:** フロントエンドの圃場管理画面の中心的な要素として Google Map を埋め込み表示する。  
       2. **圃場ポリゴン表示:** データベースに登録されている圃場の位置情報（ポリゴン座標）に基づき、地図上に管理下の圃場をポリゴンとして一覧表示する。ポリゴンのスタイル（色分け、透過度など）は、作物の種類や作業状況に応じて変更可能とする（将来的な拡張も考慮）。  
       3. **ポリゴン描画・編集:** ユーザーが Google Map 上で直感的に圃場の区画（ポリゴン）を新規作成、または既存の区画を修正できる機能を提供する。これには Google Maps Drawing Library 等の活用を想定する。  
       4. **座標データ保存:** ユーザーによって描画・編集されたポリゴンの頂点座標データを GeoJSON 形式でデータベース (Supabase の `field` テーブル、`coordinates` カラム想定) に保存する処理をバックエンド API (FastAPI) 経由で実行する。  
       5. **面積自動計算連携:** ポリゴンが描画・編集される操作の完了時に、バックエンドで面積計算処理（GitHub の既存コードまたは Google Maps Geometry Library）を呼び出し、計算結果をデータベース (Supabase の `field` テーブル、`area` カラム想定) に自動的に保存する。  
       6. **地図からの情報連携:** 地図上に表示された圃場ポリゴンをクリックまたはタップすることで、該当する圃場の詳細情報（名称、面積、作物、次の作業予定など）をポップアップウィンドウ等で簡潔に表示する。さらに、そのポップアップから圃場の詳細編集画面や関連する作業計画画面へ遷移できるリンクを提供する。  
     * **API 提供:**  
       1. 上記の圃場・作物マスタに関する CRUD (作成、読み取り、更新、削除) 操作を行うための API をバックエンド (FastAPI) で提供する。これらの API は、フロントエンドの UI 操作から利用されるほか、将来的に AI エージェント (OpenAI Agents MCP) からも呼び出せるように設計する。  
  2. **作業予定・実績管理機能**  
     * 作業内容（種まき、定植、収穫、防除等）に応じて予定と実績を登録。  
     * チャット経由での登録と、画面フォームからの直接登録の両方を可能にする。  
     * カレンダーまたはタイムライン表示で一覧できる。  
     * 作業担当者、使用農機・資材、必要時間など細かいデータ項目も扱える。  
  3. **資材・農機管理機能**  
     * 農薬・肥料など資材の在庫管理（入出庫数）を行う。  
     * トラクターやコンバインなど農機の稼働時間・メンテ状況を記録。  
     * 指定の作業に対して必要な資材・農機を紐づけることができる。  
  4. **レポート/帳票生成機能**  
     * 期間別の作業一覧、使用資材一覧などを PDF またはエクセル形式で出力できる。  
     * OpenAI Agents MCP に依頼すると自然言語でレポート作成内容を指定し、それをテキスト要約やグラフイメージにまとめる。  
* **3.2 AIエージェント (OpenAI Agents SDK) 連携機能**

  1. **チャット UI**  
     * フロントエンドでチャット画面 (React/Next.js コンポーネント) を実装。  
     * メッセージが送信されると、FastAPI サーバーが OpenAI Agents MCP を呼び出し、自然言語解析 \+ Supabase 問い合わせを行う。  
     * AI エージェントの返答をチャット画面に出力。  
  2. **質問解析とコマンド実行**  
     * OpenAI Agents MCP が受け取ったテキスト/音声 (STT 済み) を解析して、  
       1. 情報照会（例: 「○○圃場の予定を教えて」）なら Supabase SELECT  
       2. 登録・更新（例: 「△日に防除作業を登録して」）なら INSERT/UPDATE  
     * 必要に応じて確認フロー (Yes/No) を入れ、意図した操作かを再確認する。  
     * 操作後、成功/失敗ステータスや詳細をユーザーに返却。  
  3. **推論・レコメンド**  
     * 気象情報、作業履歴などに基づき「作業提案」「防除タイミング提案」等を OpenAI Agents MCP が自動生成。  
     * ユーザーが「提案を承認」など操作すれば、Supabase に登録まで行う。  
  4. **権限管理・認証**  
     * OpenAI Agents MCP 経由での操作もユーザー認証が必要。  
     * Supabase の認証機能を使用し、JWT トークンをチャット API 通信時に付与。  
     * OpenAI Agents MCP を呼び出す際に「どのユーザー (または組織) のデータを参照するか」を明確に指定。  
  5. **音声入力/出力 (オプション)**  
     * ブラウザの SpeechRecognition API やモバイルネイティブ側の STT 機能を利用。  
     * 受け取った音声をテキスト化し、OpenAI Agents MCP に送信。  
     * 音声合成(TTS)は、希望があれば Web Speech API / 外部サービスを使ってチャット回答を読み上げ。  
* **3.3 外部連携機能(将来拡張)**

  1. **気象 API 連携:** OpenWeatherMap などの API を定期呼び出し、天候データを FastAPI で管理し、AI エージェントの提案ロジックに活用。  
  2. **農薬 DB 連携:** 農水省公開データ等を参照し、農薬使用基準や希釈倍率の自動検索を行う。  
  3. **機械データ連携:** スマート農機 (GPS 付きトラクターなど) の稼働ログを API 経由で取得し、自動で作業実績を記録。  
  4. **センサー/IoT 連携:** 温湿度、土壌水分センサーの値を Supabase に蓄積し、AI が異常を検知して通知。

**4\. 非機能要件**

1. **パフォーマンス**  
   * 大規模農家や複数従業員が同時アクセスしても遅延なく地図操作、チャット操作や DB 更新ができる。  
   * 1 組織あたり圃場数は最大 400～500 件、作業記録は年間数千件を想定。  
   * OpenAI Agents MCP による自然言語解析は可能な限りリアルタイム回答を目指し、レスポンスは数秒以内を目標。  
2. **スケーラビリティ**  
   * FastAPI サーバをコンテナ化 (Docker) し、需要に合わせてスケールアウトできる設計。  
   * Supabase はスケーラブルな PostgreSQL ベースで、需要増加に対応可能。  
3. **セキュリティ**  
   * Supabase の行レベルセキュリティ (RLS) を活用し、ユーザーごとのデータ分離とアクセス制御を厳密に行う。  
   * API エンドポイントは HTTPS 必須。JWT トークン認証 (Supabase 提供)。  
   * バックエンドから外部 AI サービスを呼び出す場合、営農データの漏洩リスクを考慮。必要に応じてオンプレミスやプライベート環境を検討。  
4. **可用性**  
   * システム障害時にも Supabase のデータが破損しないよう冗長性を確保。  
   * OpenAI Agents MCP や外部 AI サービス、Google Maps Platform がダウンした場合に備え、最低限のフォーム入力機能や参照機能は利用可能とするフォールバックを用意。  
5. **操作性/UX**  
   * スマホ利用を主とし、画面はレスポンシブ対応。PC での地図操作も考慮。  
   * 片手操作がしやすい大きめの UI 要素、音声操作も含め、現場環境での利用に最適化。  
   * **地図インターフェースを活用し、圃場の位置や形状を視覚的かつ直感的に把握・管理できる UI を提供する。**  
   * 農作業時の通信不安定を考慮し、オフラインキャッシュやリトライ処理を実装するか検討。  
6. **保守・運用**  
   * ログモニタリング (アクセスログ、AI 呼び出しログ、外部 API コールログ) を整備し、障害発生時に素早く原因追跡できる体制。  
   * OpenAI Agents MCP や Google Maps Platform のバージョンアップや API の仕様変更に伴う動作影響を定期チェック・メンテナンス。  
7. **その他**  
   * **外部サービス利用:**  
     * **Google Maps Platform の利用には、API キーの取得と適切な管理が必要となる。**  
     * **Google Maps Platform の利用規約および料金体系を遵守する。利用量に応じた課金が発生する可能性があるため、コスト管理策を検討する。**

**5\. データモデル(例)**

下記は簡易的なエンティティの例です。実際の実装時には Supabase 上のスキーマ設計と、FastAPI と OpenAI Agents MCP からの操作を考慮した設計が必要です。(DB 設計ドキュメント参照)

* **Entity: User**  
  * user\_id (PK)  
  * name  
  * email  
  * password\_hash  
  * role (admin, worker, etc.)  
  * organization\_id (FK)  
* **Entity: Field(圃場)**  
  * field\_id (PK)  
  * name  
  * **coordinates (GeoJSON Polygon/MultiPolygon): 圃場の位置・形状情報。Google Map で描画・管理する。**  
  * **area (Decimal): 面積。地図上で描画されたポリゴンから自動計算された値。**  
  * crop\_type (作付品目/種類)  
  * organization\_id (FK)  
  * (その他: soil\_type, notes など)  
* **Entity: Task(作業)**  
  * task\_id (PK)  
  * field\_id (FK \-\> Field)  
  * task\_date (作業予定日 / 実施日)  
  * task\_type (enum: sowing, harvesting, etc.)  
  * worker\_id (FK \-\> User) / or multiple assignees  
  * status (planned, in-progress, done)  
  * remarks (備考)  
* **Entity: Resource(資材/農機)**  
  * resource\_id (PK)  
  * resource\_type (fertilizer, pesticide, tractor, etc.)  
  * name  
  * quantity (在庫数 / 台数)  
  * unit (個, 袋、台など)  
  * last\_maintenance\_date (農機の場合)  
  * organization\_id (FK)  
* **Entity: UsageLog(資材利用/農機稼働)**  
  * usage\_id (PK)  
  * resource\_id (FK \-\> Resource)  
  * task\_id (FK \-\> Task) or date-based  
  * amount\_used  
  * remarks  
  * organization\_id (FK)

(他に、Crop, CropWorkCategory, CropWorkflowTemplate, CultivationPlan, ScheduledTask, Calendar, CalendarEvent などのテーブルが存在。詳細は DB 設計ドキュメント参照)

**6\. 開発フロー・フェーズ**

1. **フェーズ 1: コア CRUD 機能 \+ 地図連携 UI 実装**  
   * 圃場/作物/作業予定/資材のデータモデルと基本的な CRUD API 作成 (FastAPI \+ Supabase)。  
   * ユーザー認証・組織管理機能の実装 (Supabase Auth 活用)。  
   * **地図連携機能の実装:**  
     * Google Maps Platform API キーの取得と設定。  
     * フロントエンド (React/Next.js) への Google Map コンポーネント導入と圃場ポリゴン表示。  
     * 地図上でのポリゴン描画・編集機能の実装。  
     * ポリゴン座標と自動計算された面積をバックエンド API 経由で DB に保存する処理 (面積算出コード連携含む)。  
     * 地図上のポリゴンクリック時の情報表示連携。  
   * 基本的なデータ登録・閲覧を行う管理画面 UI (React/Next.js) を用意。手動での登録・閲覧が可能な MVP を構築。  
2. **フェーズ 2: OpenAI Agents SDK ベースの AI チャット機能**  
   * チャット UI コンポーネント実装。メッセージ送受信の API を確立。  
   * OpenAI Agents MCP の導入・設定 (エージェント管理、プロンプト設計、ツール定義など)。  
   * Supabase クエリやタスク API を実行するためのインテント解析ロジック (OpenAI Function Calls) を構築。  
   * 照会系 (SELECT 系) から優先実装し、徐々に CRUD 操作 (INSERT/UPDATE) を拡張（確認フロー含む）。  
3. **フェーズ 3: レコメンド・通知機能**  
   * OpenAI Agents MCP で「気象データ参照→翌日の作業提案」「資材在庫が一定以下でアラート」などのロジックを追加。  
   * プッシュ通知 (Firebase Cloud Messaging など) でスマホにアラートを送る。  
4. **フェーズ 4: 高度化 (音声対応、画像認識、IoT 連携等)**  
   * 音声入力/出力の導入 (ブラウザ標準 API またはネイティブアプリ連携)。  
   * 画像 OCR (農薬ラベル読み込みや日報紙スキャン) → OpenAI Vision API で解析して記録に反映。  
   * 余力があれば IoT 連携の PoC を実施 (センサーやスマート農機の API 連携)。  
5. **フェーズ 5: 本番運用・継続的アップデート**  
   * 主要ユーザーからのフィードバック収集・UI/UX 改善。  
   * セキュリティ監査、ログ分析による運用最適化。  
   * 有料プラン/フリーミアムなどの課金モデル検討。

**7\. 考慮すべきリスク・課題**

1. **AI の誤回答・幻覚:** OpenAI Agents MCP が誤った回答や提案をするリスク。意図せぬ DB 操作を防ぐため、要確認フローを実装。農薬使用方法や作業手順の回答はミスが許されない領域があり、必ず公式 DB の参照や人間の最終チェックを挟むガイドラインが必要。  
2. **導入ハードル (データ整備):** 圃場リスト (特にポリゴン座標)、作付、資材などの初期データ入力が大きな手間になりがち。Excel インポート機能や初期サポートが重要。  
3. **UI/UX の複雑化:** 地図 UI、チャット UI、フォーム UI が混在するため、ユーザーが混乱しないよう、一貫性のあるスムーズな導線設計が重要。ユーザーの IT リテラシーに合わせたバランス取り。  
4. **学習済みモデルの権利・利用範囲:** OpenAI Agents MCP で学習させるデータが農家の機密情報を含む場合、プライバシーや知的財産権の扱いが問題化する可能性あり。  
5. **外部サービス依存:** Google Maps Platform や OpenAI API の仕様変更、料金改定、障害発生時の影響を考慮する必要がある。  
6. **拡張性:** 将来的に多言語対応や海外展開を視野に入れる場合、i18n 対応など早期に設計しておく。

**8\. まとめ**

本要件定義は、FastAPI \+ Supabase \+ OpenAI Agents SDK \+ Google Maps Platform を中核技術とし、「地図インターフェースとチャットベースの対話を通じて、農場管理のほぼ全操作を行う」ことを目指したシステムの設計を示しました。直感的な地図操作による圃場管理と、自然言語による容易なデータアクセス・記録を両立させます。

まずはコアとなる圃場管理 (地図連携含む) と基本的な CRUD 機能を安定させ、段階的に AI チャットの範囲を拡張することで、個人開発でも徐々に完成度を高められる想定です。音声対応や IoT 連携といった先進的な機能は後フェーズで取り入れ、ユーザーフィードバックを踏まえながらアジャイル的に機能強化していく流れが望ましいでしょう。

* **差別化ポイント:** 直感的な地図 UI による圃場管理と面積自動計算。チャット UI を軸にした自然言語でのスムーズなデータ操作。OpenAI Agents SDK を活用したエージェントによる高度な理解と行動支援。  
* **期待効果:** 圃場登録・管理の手間削減。作業計画・記録の手間削減、チーム間コミュニケーション効率化、過去データや外部データ (気象等) を基にした AI 提案で営農精度向上。Supabase と FastAPI の組み合わせによる高速・安定した運用。

